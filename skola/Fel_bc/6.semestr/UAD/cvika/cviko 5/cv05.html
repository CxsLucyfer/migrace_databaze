<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html dir="ltr" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="cz"><head>



<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-2">
<meta name="keywords" content="UNIX administration">

<title>Y36UAD -- Konfigurace syslog</title>
<link rel="stylesheet" type="text/css" href="cv05_soubory/uad.htm">
<!-- Last 17.3.2010, 100, valid X -->

</head><body> 
<h1>Konfigurace <tt>syslog</tt></h1>
<hr>
<h2>Logování systémových událostí</h2>
<p>
Jádro a øada systémových programù (daemonù) produkuje rùzné zprávy: o chybách,
varování o (ne-)oèekávaných událostech, nebo jen informace o tom, ¾e se úspì¹nì 
spustily.
</p>
<p>
Je velmi dùle¾ité mít tyto informace k&nbsp;dispozici i jindy ne¾ bezprostøednì 
po nahlá¹ení dané události. Musí proto být zapsány do souboru.
V&nbsp;dávných dobách se hlá¹ení objevovala jen na systémové konsoli, pøípadnì 
byla jednotlivými daemony zapisována do rùzných log-souborù. Nejednotnost 
a obtí¾ná konfigurace si vynutily vznik centrálního daemona pro zpracování a 
logování zpráv.
</p>
<p>
Pro tyto úèely dnes existuje nìkolik rùzných systémù na podobném principu, 
li¹ících se vìt¹inou detaily a formátem konfiguraèních souborù.
</p>
<h2><tt>syslog</tt></h2>
<p>
Tradièní a osvìdèený UNIXový prostøedek (pocházející samozøejmì z&nbsp;BSD:)
se jmenuje <abbr title="/usr/sbin/syslogd; /sbin/sysklogd; /usr/sbin/rsyslogd; ..."><tt>syslog</tt></abbr>.
Mù¾e být nakonfigurován tak, ¾e bude tøídit do¹lé zprávy do rùzných souborù, 
podle druhu nebo zdroje zprávy.
Napøíklad chybové zprávy jádra bývají umístìny do speciálního souboru, proto¾e 
se dá oèekávat, ¾e jejich dùle¾itost je vy¹¹í ne¾ u zpráv z&nbsp;jiných zdrojù.
<tt>syslog</tt> navíc umí zapisovat zprávy také na terminály nebo dokonce 
na jiné poèítaèe.
<tt>syslog</tt> je vhodné spou¹tìt mezi prvními daemony pøi startupu systému.
</p>
<p>
<tt>syslog</tt> se skládá ze tøí èástí:
</p>
<ol>
  <li><tt>syslogd</tt> (<tt>rsyslogd</tt>(8)) &#8211; logovací daemon,</li>
  <li><tt>openlog</tt>(3), <tt>syslog</tt>(2,3), <tt>closelog</tt>(3) &#8211; logovací knihovní funkce,</li>
  <li><tt>logger</tt>(1) &#8211; logovací u¾ivatelský pøíkaz.</li>
</ol>
<p>
Programy podporující <tt>syslog</tt> zapisují prostøednicvím vý¹e uvedených 
funkcí zprávy do <a href="http://moon.felk.cvut.cz/%7Ezdarekj/UAD/cv04.html">speciálního souboru (soketu)</a> 
<tt>/dev/log</tt>.
<tt>syslog</tt> zprávy dostane a podle své konfigurace rozhodne, co s&nbsp;nimi.
Speciální proces <tt>klogd</tt> vybírá zprávy z&nbsp;bufferu jádra a posílá 
je soketem k&nbsp;dal¹ímu pracování v&nbsp;<tt>syslog</tt>.
</p>
<h3>Úkol 1</h3>
<p>
Prozkoumejte typ a práva souboru <tt>/dev/log</tt>.
Najdìte a zjistìte podrobnosti procesu <tt>klogd</tt>.
Zjistìte podrobnosti o <tt>rsyslogd(8)</tt>, který 
plní funkci <tt>syslog</tt> daemonu na poèítaèích v uèebnì.
</p>
<h2>Konfigurace <tt>syslog</tt></h2>
<p>
Konfigurace se provádí v&nbsp;souboru <tt>/etc/rsyslog.conf</tt>.
Formát je velmi jednoduchý:<br>
<tt><i>selektor[;...]</i></tt>&lt;tab&gt;<tt><i>akce</i></tt><br>
Zprávy o pøihla¹ování u¾ivatelù necháme ulo¾it do souboru <tt>/var/log/authlog</tt>
tøeba takto:<br>
<tt>auth.notice	&nbsp;&nbsp;&nbsp;&nbsp;/var/log/authlog</tt>
</p>
<p>
Selektor identifikuje slu¾bu, která posílá zprávu, a úroveò (záva¾nost) dané 
zprávy, tedy 
<tt><i>selektor</i>=<i>slu¾ba.úroveò</i></tt>.
Jméno slu¾by je omezeno na hodnoty: <tt>user, kern, mail, daemon, auth, lpr,
news, uucp, cron, audit, authpriv, local0-7</tt>. Existuje také slu¾ba <tt>mark</tt> 
pro interní pou¾ití daemonem <tt>syslog</tt>. Konkrétní názvy a pøesný výèet 
slu¾eb závisí nikoliv na seznamu uvedeném na této stránce, ale na konkrétní
implementaci knihovny <tt>libc</tt> na va¹em systému.
V ka¾dém pøípadì je jejich poèet dán a programy si tedy nemohou vymý¹let 
svoje vlastní názvy, co¾ by zkomplikovalo konfiguraci.
</p>
<p>
Autoritativním zdrojem informací o dostupných slu¾bách a úrovních priority
je hlavièkový soubor 
<abbr title="/usr/include/syslog.h; /usr/include/sys/syslog.h; ..."><tt>syslog.h</tt></abbr>,
jen¾ pou¾ívají v¹echny programy se <tt>syslog</tt>em spolupracující.
</p>
<h3>Úkol 2</h3>
<p>
Zjistìte podrobnosti o zpùsobu logování pøihla¹ování u¾ivatelù na va¹em systému.
V¹e závisí na programech pøihla¹ování zaji¹»ujících, potøebujeme zjistit
jméno slu¾by, pøípadnì i prioritu. Úkol snadno vyøe¹íte, uvá¾íte-li, ¾e 
takové logování u¾ probíhá, a ¾e souborù, do nich¾ se aktuálnì loguje,
je koneèný poèet. Alternativou je prostudovat <tt>syslog.h</tt> 
a hypotézu si pak jen jednodu¹e ovìøit.
</p>
<h3>Selektor</h3>
<p>
Úrovnì záva¾nosti zprávy jsou v&nbsp;poøadí od nejvy¹¹í: 
<tt>emerg, alert, crit, err, warning, notice, info, debug</tt>, <tt>none</tt> 
øíká, ¾e zprávy z daného zdroje se nemají danou akcí zpracovávat. Opakem 
<tt>none</tt> je <tt>*</tt>, specifikující v¹e kromì <tt>mark</tt>. Napø.:<br>
<tt>*.debug;mail.none</tt><br>
øíká, ¾e se bude zpracovávat v¹e kromì zpráv z&nbsp;e-mailového provozu. 
Vidíme také, ¾e specifikace nejni¾ní úrovnì zpráv zpùsobuje pøijetí nejen této 
úrovnì, ale v¹ech vy¹¹ích ke zpracování, stanovuje <em>minimální prioritu</em>, 
od které jsou pro nás zprávy zajímavé.
Syntaxe je v&nbsp;GNU implementaci je¹tì bohat¹í, pomocí <tt>=</tt> si mù¾eme øíci
jen o danou úroveò (<tt>mail.=err</tt>), pomocí negace (<tt>!</tt>) si mù¾eme 
øíci jen o úrovnì striktnì men¹í ne¾ je uvedená. 
<tt>mail.!notice</tt> tedy vybere jen <tt>info</tt> a <tt>debug</tt>.
Oba operátory lze zkombinovat: <tt>mail.!=notice</tt> vybere v¹echny zprávy
typu <tt>mail</tt> kromì úrovnì <tt>notice</tt>.
</p>
<h3>Akce</h3>
<ol>
  <li><tt>/dir/soubor</tt> &#8211; zapsat do souboru.</li>
  <li><tt>-/dir/soubor</tt> &#8211; zapsat do souboru bez volání <tt>sync()</tt>.</li>
  <li><tt>|/dir/fifo</tt> &#8211; zapsat do pojmenované roury.</li>
  <li><tt>username</tt> &#8211; zapsat na terminál u¾ivatele <tt>username</tt>, 
          pokud je pøihlá¹en.</li>
  <li><tt>*</tt> &#8211; zapsat na terminál v¹ech pøihlá¹ených u¾ivatelù.</li>
  <li><tt>@ip-adresa</tt> &#8211; poslat UDP paket <tt>syslog</tt>u na poèítaè s&nbsp;danou IP adresou.</li>
  <li><tt>@jmeno</tt> &#8211; poslat <tt>syslog</tt>u na poèítaè <tt>jmeno</tt>. Lépe je specifikovat IP adresu, DNS nemusí být dostupná.</li>
  <li><tt>@@ip-adresa</tt> &#8211; nìkteré <tt>syslog</tt> daemony umí té¾ 
      posílat <tt>syslog</tt>u na poèítaè s&nbsp;danou IP adresou zprávy protokolem TCP.</li>
</ol>
<p>
Standardnì umí <tt>syslog</tt> komunikovat po síti protokolem UDP na vyhrazený 
port 514, konkrétní implementace (napø. <tt>rsyslogd</tt>) v¹ak mohou podporovat
i TCP na portu 514. (Èísla portù se dají nastavit dle potøeby.)
</p>
<h3>Ovìøení konfigurace</h3>
<p>
Ovìøení nového nastavení patøí mezi základní úkony, které administrátor musí 
zajistit. V&nbsp;na¹em pøípadì to snadno provedeme pøíkazem <tt>/usr/bin/logger</tt>.
Pøedtím ale musíme nechat proces <tt>rsyslogd</tt> znovu naèíst jeho 
konfiguraèní soubor, proto¾e stejnì jako jiné daemony i <tt>rsyslogd</tt> ète 
konfiguraci pouze pøi startu, a pak se podle ní øídí. 
Vedlej¹ím efektem bude také uzavøení a nové otevøení v¹ech souborù logù, 
co¾ se vyu¾ívá pøi zálohování nebo smazání starých nebo pøíli¹ velkých 
log-souborù.
</p>
<p>
®ádost o znovunaètení konfigurace se 
provede posláním signálu HUP procesu <tt>rsyslogd</tt>. Vìt¹ina daemonù ukládá 
PID bì¾ícího procesu do textového souboru, èeho¾ vyu¾ijeme, abychom se 
nezdr¾ovali hledáním správného PID:<br>
<tt># /bin/kill -HUP `/bin/cat /var/run/rsyslogd.pid`</tt>
</p>
<h3>Úkol 3</h3>
<p>
Ujistìte se, ¾e zprávy typu <tt>mail</tt> jsou nìkam logovány a vyzkou¹ejte je:<br>
<tt>logger -p mail.warning "Posta neni nakonfigurovana."</tt>
</p>
<h3>Úkol 4</h3>
<p>
Zprávy <tt>local6.crit</tt> a vy¹¹í vypisujte na terminál u¾ivatele <tt>user1</tt>,
zprávy <tt>local6.emerg</tt> v¹em u¾ivatelùm.
Ovìøte správnost svého nastavení pøíkazem <tt>logger</tt>.
</p>
<h3>Úkol 5</h3>
<p>
Po dohodì se cvièícím vytvoøte skupiny poèítaèù (typicky dva, detaily urèí 
cvièící) a spoleènì nakonfigurujte a zprovoznìte centrální sí»ový logovací 
server va¹í skupiny.<br>
Vyberte si vhodný typ zpráv, který budete pøedávat, napø.&nbsp;<tt>auth</tt>
o pøihla¹ování u¾ivatelù, pokuste se tentokrát vyzkou¹et nastavení bez pou¾ití 
pøíkazu <tt>logger</tt>. Nezapomeòte, ¾e z&nbsp;bezpeènostních dùvodù 
mívá <tt>rsyslogd</tt> zakázáno pøijímat zprávy ze sítì, je potøeba zajistit 
jeho nové spu¹tìní s pùvodními parametry a navíc s&nbsp;parametrem <tt>-r</tt>.
(K prozkoumání èinnosti a pochopení parametrù <tt>rsyslogd</tt> slou¾il úkol 1,
vyu¾ijte jich.)
</p>
<p>
Na strojích je aktivní firewall, pøípadné problémy 
diagnostikujte pomocí <tt>tcpdump</tt>(1), konsultujte 
s&nbsp;<tt>iptables</tt>(8), pøípadnì se svým cvièícím.
</p>
<hr>
<p><img src="cv05_soubory/ESFgrant.png" alt="Partially supported by ESF and City of Prague." width="161" height="22"></p>
</body></html>
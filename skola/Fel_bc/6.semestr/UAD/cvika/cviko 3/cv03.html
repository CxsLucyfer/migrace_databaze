<?xml version="1.0" encoding="iso-8859-2" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="cz" dir="ltr">
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-2" />
<meta name="keywords" content="UNIX administration" />

<title>Y36UAD -- Analýza a úpravy rc-skriptù</title>
<link rel="stylesheet" type="text/css" href="./uad.css" />
</head>
<!-- Last 29.3.2008, 91, valid X -->

<body> 
<h1>Analýza a úpravy startovacích skriptù</h1>
<hr />
<h2>Start systému</h2>
<p>
Operaèní systém UNIX se startuje v následujících fázích:
</p>
<ul>
<li> Superblok (bootblok, první blok na disku),</li>
<li> zavadìè (zpravidla víceúrovòový, umí na disku najít a pøeèíst jádro),</li>
<li> jádro (spustí program <tt>init</tt>),</li>
<li> program <tt>init</tt> (spou¹tí jednotlivé rc-skripty v&nbsp;závislosti na 
runlevelu),</li>
<li> rc-skripty (inicializují systém, spou¹tìjí daemony).</li>
</ul>
<p>
Cílem cvièení bude procvièit konfiguraci startup-fáze, tedy fáze zavádìní 
souèástí systému po spu¹tìní procesu <tt>init</tt>.
</p>
<h2>Proces <tt>init</tt></h2>
<p>
Proces <tt>init</tt> spou¹tí rc-skripty podle konfiguraèního souboru 
<tt>/etc/inittab</tt>. Pøipomìòme si jeho strukturu, tvoøenou øádky:<br />
<tt>id:runlevel:zpùsob:pøíkaz</tt><br />
</p>
<table style="border: 1px solid gray;">
<tr><td><tt>id</tt></td><td>jednoznaèný dvouznakový identifikátor øádku</td></tr>
<tr><td><tt>rulevel</tt></td><td>runlevely, pro které je øádek aktivní &ndash; 
            navzájem nièím neoddìlené znaky 0-6, S nebo s</td></tr>
<tr><td style="vertical-align: top;"><tt>zpùsob</tt></td><td>oznaèuje zpùsob spou¹tìní:<br />
 <table>
 <tr><td>&nbsp;</td><td>respawn</td>
     <td>opakované spou¹tìní &ndash; po ukonèení je spu¹tìn znova</td></tr>
 <tr><td></td><td>wait</td>
     <td>jednorázové spu¹tìní, <tt>init</tt> èeká na dokonèení procesu a pak
         pokraèuje dal¹ími akcemi</td></tr>
 <tr><td></td><td>once</td>
     <td>proces bude spu¹tìn jednou, pøi vstupu do daného runlevelu</td></tr>
 <tr><td></td><td>sysinit</td>
     <td>proces se spustí jednou pøi startu systému</td></tr>
 <tr><td></td><td>powerfail</td>
     <td>proces se spustí, kdy¾ pøijde signál SIGPWR (zálohovací zdroj napájení (UPS) detekuje výpadek napájení)</td></tr>
 </table></td></tr>
<tr><td><tt>pøíkaz</tt></td><td>program èi skript s&nbsp;pøípadnými parametry, který se má spustit</td></tr>
</table>
<h2>Runlevely</h2>
<p>
Runlevel je vlastnì stav standardních procesù (slu¾eb) systému, 
vzdálenì pøipomínající re¾imy <em>normální</em>, <em>nouzový</em>
u operaèního systému MS Windows. Zásadní rozdíl je v tom, ¾e administrátor mù¾e
runlevel mìnit nejen pøi startu, ale kdykoliv je to potøeba. 
Dùle¾itou vlastností je, ¾e lze snadno vytvoøit dal¹í, speciální runlevel, 
nebo jednodu¹e mìnit vlastnosti standardních runlevelù. S&nbsp;dostupnými 
runlevely (0,1,2,3,4,5,6,s,S,7-9,a-c) a jejich významem jste se seznámili na 
pøedná¹ce.
</p>
<h2>Zmìna runlevelu</h2>
<p>
Zmìnu runlevelu mù¾eme provést programem <tt>/sbin/telinit</tt>, 
resp.&nbsp;pøímo <tt>/sbin/init</tt>, kterému po¾adovaný runlevel pøedáme jako 
parametr.
Napøíklad <tt>init 6</tt> provede vypnutí daemonù a restart poèítaèe.
<tt>init 0</tt> provede vypnutí daemonù a vypnutí poèítaèe, pokud to HW umo¾òuje.
(<tt>init</tt> je chytøe napsaný, a proto ví, ¾e pokud nebì¾í s&nbsp;PID=1,
má se chovat jako <tt>telinit</tt>, <tt>/sbin/telinit</tt> je tedy jen link. 
Ovìøte!)
</p>
<p>
Úèelem runlevelù je zamezit u¾ivatelùm v pou¾ívání tìch èástí systému, které
zrovna správce mìní, nebo opravuje. Chce-li administrátor mìnit konfiguraci
<i>http serveru</i>, mìl by pøejít napø. do runlevelu 2, kde sice mohou 
u¾ivatelé normálnì pracovat, ale jsou pozastaveny nabízené sí»ové slu¾by. 
Z na¹eho hlediska je nejdùle¾itìj¹í runlevel 3 (bì¾ný provoz), 
5 (bì¾ný provoz, pokud se chceme pøihla¹ovat v grafickém rozhraní &ndash; 
v tomto pøípadì je dobré dát 5 jako implicitní runlevel do souboru 
<tt>inittab</tt> &ndash; viz polo¾ka 
<tt>initdefault</tt>) a runlevel S (radikální administrace). 
Runlevel S je zvlá¹tì dùle¾itý pro opravu poru¹ených systémù souborù. 
Disky lze kontrolovat jen odpojené a odpojit je lze jen, kdy¾ k danému 
systému souborù nepøistupuje ¾ádný proces. Proto je pøi opravì diskù zcela 
nezbytné pøejít do runlevelu S, kdy jsou ukonèeny v¹echny u¾ivatelské procesy 
a je tedy mo¾né systém souborù odpojit za úèelem oprav.
</p>
<h3>Úkol 1:</h3>
<p>
Zkuste pøepnout runlevel na 2 a po nìjaké dobì zpìt na 3.
Pozorujte zmìny. Porovnejte bì¾ící procesy.
</p>  
<p>
Pøi aktivaci runlevelu spou¹tí proces <tt>init</tt> na základì øádek
</p>
<pre>
l0:0:wait:/etc/rc.d/rc 0
l1:1:wait:/etc/rc.d/rc 1
l2:2:wait:/etc/rc.d/rc 2
l3:3:wait:/etc/rc.d/rc 3
l4:4:wait:/etc/rc.d/rc 4
l5:5:wait:/etc/rc.d/rc 5
l6:6:wait:/etc/rc.d/rc 6
</pre>
<p>
skript <tt>/etc/rc.d/rc</tt> s èíslem cílového runlevelu jako parametrem. 
</p>
<h3>Úkol 2:</h3>
<p>
Najdìte ve skriptu <code>/etc/rc.d/rc</code> èást, která spou¹tí startovací 
skripty jednotlivých subsystémù.
</p>
<h2>Ovládání jednotlivých slu¾eb, daemonù</h2>
<p>
Pokud administrátor potøebuje doèasnì pozastavit provoz nìkterého ze
daemonù (napø. za úèelem oprav, èi zálohování), mù¾e ho ovládat
pøíslu¹ným startovacím skriptem (rc-skriptem) z adresáøe 
<tt>/etc/rc.d/init.d</tt>.
Skripty reagují na parametry <tt>start</tt> a <tt>stop</tt>, èasto ale i 
na dal¹í, jako napø. <tt>status</tt> a <tt>restart</tt>.
</p>
<p>
Napø. pøíkaz<br />
<tt>/etc/rc.d/init.d/sshd stop</tt><br />
zpùsobí zastavení daemona SSH serveru, umo¾òujícího vzdálené interaktivní 
pøihlá¹ování.
Znovu jej spustíme stejným pøíkazem, ale s parametrem <tt>start</tt>.
</p>
<p>
Na nìkterých distribucích (Fedora) existuje usnadnìní v podobì skriptu 
<tt>service</tt>. Není nutné poka¾dé psát plnou cestu k rc-skriptùm, staèí
napø. místo pøedchozího pøíkladu napsat<br />  
<code>service sshd stop</code>.
</p>
<h2>Automatické startování slu¾eb, daemonù</h2>
<p>
Pro ka¾dý runlevel je pøedepsáno, jaké systémy se mají spustit a které se
mají zastavit. Konrétní umístìní a pojmenování adresáøù a linkù se v¹ak 
èasto li¹í. Pro Fedoru, její¾ systém je blízký pùvodní System V koncepci, 
je pøedpis tvoøen symbolickými linky z adresáøù
<tt>/etc/rc.d/rc?.d/</tt> zvlá¹» pro ka¾dý runlevel do adresáøe
<tt>/etc/rc.d/init.d/</tt>. Podívejte se napø. pro runlevel 3 do adresáøe
<tt>/etc/rc.d/rc3.d/</tt>: jsou tam jednak linky zaèínající písmenem K
urèující, které systémy mají být zastaveny pøi vstupu do runlevelu 3, 
a jednak zaèínající písmeny S, které definují startovací akce. Dvojèíslí ve
jménì linku urèuje poøadí provádìní. V¹imìte si, ¾e existují napø. linky 
<tt>S10network</tt> a <tt>S11portmap</tt> &ndash; sí»ový program <tt>portmap</tt>
se spustí a¾ po inicializaci sí»ových adaptérù, které pou¾ívá. 
Nechcete-li automaticky spou¹tìt nìkterý subsystém, staèí daný link smazat, 
nebo pøejmenovat na link s prvním písmenem K.
</p>
<h2>Automatizovaná správa rc-skriptù</h2>
<p>
Na vìt¹inì distribucí existují pomùcky pro udr¾ování symbolických linkù 
spou¹tìných slu¾eb z adresáøù <tt>/etc/rc.d/rc?.d</tt> do 
<tt>/etc/rc.d/init.d</tt> usnadòuje na Fedoøe program <tt>chkconfig</tt>.
Umí pøidat èi zru¹it provádìní urèitého rc-skriptu v daném runlevelu, pøípadnì 
vypsat nastavení.
</p>
<!--
<P>
Zkuste si vyrobit vlastní startovací script reagující na parametr start/stop
pro svùj vlastní subsystém. Øeknìme, ¾e nebude spou¹tìt ¾ádné démony, ale
prostì jen vytvoøí èi sma¾e napø. soubor <TT>/tmp/bezi_muj_subsystem</TT>.
Nyní ho nakopírujte do <TT>/etc/init.d</TT> a zkuste ho zaøadit do nìkterých
runlevelù ruènì nebo pomocí programu <TT>chkconfig</TT>. Otestujte pøechody
mezi runlevely, sledujte, jak se vá¹ subsystém spou¹tí a ukonèuje.
-->

<h3>Úkol 3:</h3>
<p>
Prostudujte rc-skript <tt>/etc/init.d/crond</tt>. Pou¾ijte tento
skript k ruènímu zablokování pravidelnì naplánovaných úloh a ovìøte, ¾e
pravidelnì plánované úlohy se pøestaly spou¹tìt. Poté daemona <tt>crond</tt> 
opìt spus»te.
</p>
<h2>Singleuser mód</h2>
<p>
Pøi záva¾nìj¹ích poruchách systému se mù¾e stát, ¾e nìkterý startovací
skript uvázne, systém nedokonèí startup fázi a u¾ivatel, ani <tt>root</tt>, 
se nemù¾e pøihlásit, aby problém odstranil. V takových pøípadech je mo¾né
restartovat systém do runlevelu <b>S</b>, kdy se spou¹tí jen minimum
startovacích skriptù a je tedy vìt¹í ¹ance, ¾e systém dovolí správci
pøihlá¹ení a tím analyzovat a opravit poruchu. Po spu¹tìní poèítaèe je 
nutné v programu zavádìjícím jádro zadat parametr jádra <tt>S</tt>, <tt>s</tt> 
nebo <tt>single</tt>, který zpùsobí start pøímo do runlevelu S.
</p>
<p>
V následujícím úkolu zkusíme na základì pøedchozích poznatkù vytvoøit vlastní
souèást systému rc-skriptù a vyzkou¹íme její funkènost pøi zmìnách runlevelu.
</p>
<h3>Úkol 4:</h3>
<ol>
  <li>Vytvoøte vlastní testovací rc-skript.</li>
  <li>Pokud skript obdr¾í parametr <tt>start</tt>, 
  vypí¹e na svùj standardní výstup aktuální datum a èas a seznam bì¾ících 
  procesù (<tt>ps</tt>(1)).
  <!-- vypí¹e do souboru aktuální datum a èas a seznam bì¾ících 
  procesù (<tt>ps</tt>(1)).
  Jméno souboru bude naèítat ze svého konfiguraèního souboru v adresáøi
  <tt>/etc/sysconfig</tt>.<br />
  (Pro provozní informace rùzných systémových programù se èasto pou¾ívá 
  adresáø <tt>/var/run</tt>, vyu¾ijte jej.
  -->
  <br />
  Pøíklad výstupu:
<pre>
--- Wed Mar 12 19:05:23 CET 2008 ---
  PID TTY          TIME CMD
    1 ?        00:00:01 init
    2 ?        00:00:00 kthreadd
    3 ?        00:00:00 ksoftirqd/0
    4 ?        00:00:04 events/0
    5 ?        00:00:00 khelper
   82 ?        00:00:00 kblockd/0
   86 ?        00:00:00 kacpid
   87 ?        00:00:00 kacpi_notify
  185 ?        00:00:00 ata/0
  186 ?        00:00:00 ata_aux
  187 ?        00:00:00 ksuspend_usbd
  192 ?        00:00:00 khubd
  195 ?        00:00:00 kseriod
  244 ?        00:00:00 pdflush
  245 ?        00:00:00 pdflush
  246 ?        00:00:00 kswapd0
  247 ?        00:00:00 aio/0
  248 ?        00:00:00 cifsoplockd
  249 ?        00:00:00 cifsdnotifyd
  422 ?        00:00:00 scsi_eh_0
  424 ?        00:00:00 scsi_eh_1
  426 ?        00:00:00 khpsbpkt
  436 ?        00:00:00 knodemgrd_0
  488 ?        00:00:00 kpsmoused
  501 ?        00:00:00 kondemand/0
  523 ?        00:00:00 rpciod/0
  525 ?        00:00:01 kjournald
  618 ?        00:00:00 udevd
 1143 ?        00:00:00 kjournald
 1876 ?        00:00:00 syslogd
 1886 ?        00:00:00 klogd
15037 tty1     00:00:00 rc
15932 tty1     00:00:00 S10logskript
16091 tty1     00:00:00 ps
-- -- -- -- -- -- -- -- -- -- -- --
</pre>
  Obdr¾í-li parametr <tt>stop</tt>, vypí¹e jen aktuální datum a èas a jméno 
  skriptu.
  Pøíklad výstupu:
<pre>
== Wed Mar 12 19:09:22 CET 2008: logskript ==
</pre>
  (Za výstupní operaci lze dát té¾ volání <tt>sleep</tt>(1), abyste si výpisu stihli v¹imnout.)
  </li>
  <li>Pøidejte mezi linky na rc-skripty spou¹tìné v runlevelu <b>1</b> link 
  na svùj nový skript.</li>
  <li>Pøejdìte nyní do runlevelu S (na GNU/Linuxu pøes runlevel 1) pøíkazem<br />
  <tt>telinit 1</tt><br />
  a vyzkou¹ejte jeho funkènost.</li>
  <li>Pøidejte link na tento nový skript mezi linky na rc-skripty, které se 
  mají ukonèit v runlevelu <b>2</b>.</li>
  <li>Pøejdìte nyní do runlevelu 2 pøíkazem<br />
  <tt>telinit 2</tt><br />
  a vyzkou¹ejte jeho funkènost.</li>
</ol>
<h2>Vypínání a restart systému</h2>
<p>
Pøepnutí runlevelu mù¾e slou¾it rovnì¾ k restartu èi vypnutí poèítaèe.
Restart resp. zastavení systému lze provést pøíkazem <tt>init 6</tt>, 
resp. <tt>init 0</tt>, jak bylo uvedeno vý¹e. Bì¾nì se v¹ak zastavuje èi 
restartuje systém pøíkazem <tt>shutdown</tt>, který umo¾ní poslat pøihlá¹eným 
u¾ivatelùm varování a odlo¾it provedení na stanovenou dobu, aby u¾ivatelé 
stihli ukonèit svou práci.
</p>
<h3>Úkol 5:</h3>
<p>
Podívejte se na <tt>shutdown</tt>(8) a vyzkou¹ejte pøíkaz<br />
<tt>shutdown -r +1 "Server bude za minutu restartovan."</tt><br />
Má-li systém pøeru¹it svoji èinnost, není vhodné, aby se pøihla¹ovali dal¹í 
u¾ivatelé, <tt>shutdown</tt> proto vyrobí soubor <tt>/etc/nologin</tt>.
Ovìøte existenci tohoto souboru. Existuje tento soubor i po restartu?
</p>
<h3>Bodované úlohy</h3>
<p>
Vyøe¹te bodované úlohy zadané cvièícím a pøedveïte mu jejich správná øe¹ení.
</p>
<hr />
<p><img src="../obr/ESFgrant.png" width="161" height="22" alt="Partially supported by ESF and City of Prague." /></p>
</body>
</html>
